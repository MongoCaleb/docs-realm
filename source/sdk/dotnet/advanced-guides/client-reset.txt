.. _dotnet-client-resets:

========================
Client Resets - .NET SDK
========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

When using :ref:`Device Sync <sync>`, it is possible that your client app will 
need to handle a **client reset**. While not a common event, you need to perform 
a client reset when Sync is terminated on the server. For example, when a developer 
deploys a change that includes a destructive schema change. To fix this, you must 
stop Sync, modify the schema, and then re-enable Sync. This process causes the 
server to send a client reset message to the clients.

By default, the SDK handles client reset messages automatically, but only on app 
startup. Until the app is restarted, users will receive no new data from the server,
and any changes on the device are lost when the app is restarted and the 
reset happens.

The .NET SDK provides the option to specify a client 
reset strategy in your :dotnet-sdk:`PartitionSyncConfiguration 
<reference/Realms.Sync.PartitionSyncConfiguration.html>` and 
:dotnet-sdk:`FlexibleSyncConfiguration 
<reference/Realms.Sync.FlexibleSyncConfiguration.html>`. The 
:dotnet-sdk:`ClientResetHandler <reference/Realms.Sync.SyncConfigurationBase.html#Realms_Sync_SyncConfigurationBase_ClientResetHandler>` 
property can be set to one of the following:

.. list-table::
   :header-rows: 1
   :widths: 30 30 50
   
   * - Handler
     - Strategy
     - Notes

   * - :dotnet-sdk:`RecoverOrDiscardUnsyncedChangesHandler <reference/Realms.Sync.ErrorHandling.RecoverOrDiscardUnsyncedChangesHandler.html>`
       **(Default handler)**
     - Attempts to recover all unsynced local changes.
     - If recovery fails, this handler falls back to the DiscardUnsyncedChangesHandler, 
       which deletes all unsycned local changes. This is the default client 
       reset handler.

   * - :dotnet-sdk:`RecoverUnsyncedChangesHandler <reference/Realms.Sync.ErrorHandling.RecoverUnsyncedChangesHandler.html>`
     - Attempts to recover all unsynced local changes.
     - If recovery fails, this handler falls back to a ManualRecoveryHandler, which
       requires you to implement a recovery strategy.

   * - :dotnet-sdk:`DiscardUnsyncedChangesHandler <reference/Realms.Sync.ErrorHandling.DiscardUnsyncedChangesHandler.html>`
     - Restores your local realm file to a syncable state
     - This strategy *permanently deletes* all local unsynced changes made since 
       the last successful sync.

   * - :dotnet-sdk:`ManualRecoveryHandler <reference/Realms.Sync.ErrorHandling.ManualRecoveryHandler.html>`
     - Provides a way for you to implement your own recovery strategy.
     - Requires deleting the local realm.


Client Reset Scenarios
----------------------
The following sections describe how you can use each of the 
``ClientResetHandlers``.

RecoverOrDiscardUnsyncedChangesHandler
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This strategy attempts to recover all unsynced local changes automatically. It is 
the default strategy, as it provides the most robust recovery process. If the 
recovery process fails, it falls back to the DiscardLocalReset strategy explained 
below. If that process fails, it falls back again to the Manual Reset strategy. 
This handler provides the following callback methods:

- :dotnet-sdk:`OnBeforeReset 
  <>`, 
  which the SDK invokes prior to the client reset. You can use this callback to notify 
  the user before the reset begins.

- :dotnet-sdk:`OnAfterRecovery
  <>`, 
  which the SDK invokes if -- and only if -- the automatic reset completes successfully. 
  You can use it to notify the user that the client reset is complete.

- :dotnet-sdk:`OnAfterDiscard 
  <>`, 
  which the SDK invokes only if the automatic client reset fails **and** the discard 
  local strategy *succeeds*. If the discard strategy fails, this callback is not 
  invoked.

- :dotnet-sdk:`ManualResetFallback 
  <>`, 
  which the SDK invokes only if the automatic 
  recovery and the discard strategy have failed. You implement this callback to 
  handle the reset failure. Your logic here will 
  be similar to that described for a 
  :ref:`ManualRecoveryHandler <manual_recovery_handler>`.

The following example shows using each of these callbacks:

.. literalinclude:: /examples/generated/dotnet/ClientResetExamples.snippet.RecoverOrDiscardUnsyncedChangesHandler.cs
   :language: csharp


RecoverUnsyncedChangesHandler
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Like the ``RecoverOrDiscardUnsyncedChangesHandler``, this strategy attempts to 
recover all unsynced local changes automatically. Unlike 
``RecoverOrDiscardUnsyncedChangesHandler``, however, this handler requires a 
manual reset if the automatic recovery fails. The handler provides the following 
callback methods:

- :dotnet-sdk:`OnBeforeReset 
  <>`, 
  which you can use to notify the user before the reset begins.

- :dotnet-sdk:`OnAfterReset 
  <>`, 
  which you can use to notify the user when the reset has completed successfully.

- :dotnet-sdk:`ManualResetFallback 
  <>`, 
  which you implement to handle a reset failure. Your logic here will 
  be similar to that described for a 
  :ref:`ManualRecoveryHandler <manual_recovery_handler>`.

The following example shows using each of these callbacks:

.. literalinclude:: /examples/generated/dotnet/ClientResetExamples.snippet.RecoverUnsyncedChangesHandler.cs
   :language: csharp

DiscardUnsyncedChangesHandler
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When you specify a ``DiscardUnsyncedChangesHandler`` on a 
``PartitionSyncConfiguration`` object, the SDK restores your local realm file 
to a syncable state without closing the realm and while maintaining notifications. 
However, this strategy *permanently deletes* all local unsynced changes 
made since the last successful sync. 

This handler provides the following callback methods:

- :dotnet-sdk:`OnBeforeReset 
  <reference/Realms.Sync.ErrorHandling.DiscardUnsyncedChangesHandler.html#Realms_Sync_ErrorHandling_DiscardUnsyncedChangesHandler_OnBeforeReset>`, 
  which the SDK invokes prior to the client reset. You can use this callback to notify 
  the user before the reset begins.

- :dotnet-sdk:`OnAfterReset 
  <reference/Realms.Sync.ErrorHandling.DiscardUnsyncedChangesHandler.html#Realms_Sync_ErrorHandling_DiscardUnsyncedChangesHandler_OnAfterReset>`, 
  which the SDK invokes if -- and only if -- the reset completes successfully. 
  You can use it to notify the user when the reset is complete.

- :dotnet-sdk:`ManualResetFallback <reference/Realms.Sync.ErrorHandling.DiscardUnsyncedChangesHandler.html#Realms_Sync_ErrorHandling_DiscardUnsyncedChangesHandler_ManualResetFallback>`,
  which the SDK invokes if the reset fails. Your logic here will 
  be similar to that described for a 
  :ref:`ManualRecoveryHandler <manual_recovery_handler>`.

.. example::

   The following example shows how you might configure the ``OnBeforeReset``, 
   ``OnAfterReset``, and ``ManualResetFallback`` callbacks.

   .. literalinclude:: /examples/generated/dotnet/ClientResetExamples.snippet.DiscardUnsyncedChangesHandler.cs
      :language: csharp

.. _manual_recovery_handler:

ManualRecoveryHandler
~~~~~~~~~~~~~~~~~~~~~
The 
:dotnet-sdk:`ManualRecoveryHandler(ClientResetException) <reference/Realms.Sync.ErrorHandling.ManualRecoveryHandler.html#Realms_Sync_ErrorHandling_ManualRecoveryHandler__ctor_Realms_Sync_ErrorHandling_ClientResetHandlerBase_ClientResetCallback_>` 
method provides a way to customize your reset strategy. The other handlers fallback 
to a manual strategy if the other options fail (as in the case of a destructive schema 
change). 

Within the 
``ManualRecoveryHandler``, you dispose the existing realm, and then call the 
:dotnet-sdk:`InitiateClientReset() <reference/Realms.Sync.Exceptions.ClientResetException.html#Realms_Sync_Exceptions_ClientResetException_InitiateClientReset>` 
method.

.. example::

   The following example demonstrates implementing the ManualRecoveryHandler:

   .. literalinclude:: /examples/generated/dotnet/ClientResetExamples.snippet.ManualClientReset.cs
      :language: csharp

.. important::

   Be sure to use the overload of the ``ManualRecoveryHandler`` that takes a 
   :dotnet-sdk:`ClientResetException <reference/Realms.Sync.Exceptions.ClientResetException.html>` 
   parameter.
